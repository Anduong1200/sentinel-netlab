# syntax=docker/dockerfile:1.7
FROM python:3.11-slim-bookworm AS builder
WORKDIR /build

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc libpq-dev \
    && rm -rf /var/lib/apt/lists/*

COPY pyproject.toml README.md sentinel.py ./
COPY controller/ controller/
COPY common/ common/
COPY algos/ algos/
# ML might be needed for analysis
COPY ml/ ml/

RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Build wheels for controller dependencies
RUN pip install -U pip setuptools wheel && \
    pip wheel --wheel-dir /wheels ".[controller]" && \
    # Security: Build wheels for vulnerable packages at secure versions
    pip wheel --wheel-dir /wheels "jaraco.context>=6.1.0" "wheel>=0.46.2"

FROM python:3.11-slim-bookworm AS runtime
WORKDIR /app

# runtime deps for postgres
RUN apt-get update && apt-get install -y --no-install-recommends curl libpq5 \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -m -u 10001 sentinel

COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/*.whl && rm -rf /wheels

# Change ownership of venv to sentinel user
RUN chown -R sentinel:sentinel /opt/venv

USER sentinel

COPY --chown=sentinel:sentinel controller/ ./controller/
COPY --chown=sentinel:sentinel common/ ./common/
COPY --chown=sentinel:sentinel algos/ ./algos/
COPY --chown=sentinel:sentinel sentinel.py ./sentinel.py
COPY --chown=sentinel:sentinel config.example.yaml ./config.yaml

HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
    CMD curl -fsS http://127.0.0.1:5000/api/v1/health || exit 1

CMD ["python", "sentinel.py", "controller"]
