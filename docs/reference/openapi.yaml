openapi: 3.0.3
info:
  title: Sentinel NetLab Controller API
  description: |
    API for the centralized Sentinel NetLab Controller.
    Handles telemetry ingestion, alert management, and sensor orchestration.
  version: 2.0.0
  contact:
    name: Sentinel NetLab Team
    url: https://github.com/Anduong1200/sentinel-netlab
servers:
  - url: /api/v1
    description: V1 API

security:
  - bearerAuth: []

paths:
  /health:
    get:
      summary: Health Check
      description: Returns service health status.
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  version:
                    type: string

  /telemetry:
    post:
      summary: Ingest Telemetry
      description: Ingests a batch of telemetry items from a sensor.
      operationId: ingestTelemetry
      security:
        - bearerAuth: []
        - hmacAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TelemetryBatch"
      responses:
        "200":
          description: Batch accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accepted:
                    type: integer
        "400":
          description: validation error
    get:
      summary: Query Telemetry
      description: Retrieve stored telemetry data.
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: sensor_id
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of telemetry items
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/TelemetryItem"

  /networks:
    get:
      summary: Get Recent Networks
      description: Returns a deduplicated list of recently seen networks (snapshot).
      responses:
        "200":
          description: Network list
          content:
            application/json:
              schema:
                type: object
                properties:
                  networks:
                    type: array
                    items:
                      $ref: "#/components/schemas/TelemetryItem"

  /alerts:
    post:
      summary: Create Alert
      description: Report a security alert from a sensor.
      security:
        - bearerAuth: []
        - hmacAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AlertCreate"
      responses:
        "200":
          description: Alert Created
    get:
      summary: List Alerts
      parameters:
        - name: severity
          in: query
          schema:
            type: string
            enum: [Critical, High, Medium, Low, Info]
      responses:
        "200":
          description: List of alerts
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Alert"

  /reports/generate:
    post:
      summary: Generate PDF Report
      description: Generates a PDF report from provided audit data.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                report:
                  type: object
                summary:
                  type: object
                findings:
                  type: array
      responses:
        "200":
          description: PDF Report
          content:
            application/pdf:
              schema:
                type: string
                format: binary

  /sensors/heartbeat:
    post:
      summary: Sensor Heartbeat
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                metrics:
                  type: object
      responses:
        "200":
          description: Heartbeat acknowledged

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Opaque
    hmacAuth:
      type: apiKey
      in: header
      name: X-Signature
      description: HMAC-SHA256 signature of request body (with X-Timestamp)

  schemas:
    TelemetryItem:
      type: object
      properties:
        bssid:
          type: string
          pattern: "^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$"
        ssid:
          type: string
        channel:
          type: integer
        rssi_dbm:
          type: integer
        timestamp:
          type: string
          format: date-time
        gps:
          type: object
          properties:
            lat:
              type: number
            lon:
              type: number

    TelemetryBatch:
      type: object
      required:
        - sensor_id
        - items
      properties:
        sensor_id:
          type: string
        batch_id:
          type: string
        items:
          type: array
          items:
            $ref: "#/components/schemas/TelemetryItem"

    AlertCreate:
      type: object
      required:
        - alert_type
        - severity
        - title
      properties:
        alert_type:
          type: string
        severity:
          type: string
          enum: [Critical, High, Medium, Low, Info]
        title:
          type: string
          example: "Evil Twin Detected"
        description:
          type: string
        evidence:
          type: object

    Alert:
      allOf:
        - $ref: "#/components/schemas/AlertCreate"
        - type: object
          properties:
            id:
              type: string
            created_at:
              type: string
              format: date-time
