# FTP Exploits (Khai thác/ lạm dụng FTP & FTPS)

> **Phạm vi:** mô tả kỹ thuật và kiểm soát **phòng thủ** cho các rủi ro liên quan đến **FTP (File Transfer Protocol)**, gồm: lộ thông tin xác thực do truyền rõ, brute‑force/password spraying, chiếm quyền truy cập file, lạm dụng cấu hình Active/Passive mode, và rủi ro triển khai **FTPS** (FTP over TLS) sai cách.  
> **Nguyên tắc an toàn:** không cung cấp hướng dẫn khai thác dạng step‑by‑step/command cụ thể; chỉ mô tả cơ chế, điều kiện, dấu hiệu và biện pháp giảm thiểu/giám sát.

---

## 1) Thông tin kỹ thuật (Technical Information)

### 1.1 Giao thức liên quan (FTP là lõi; 802.11/WPA/EAP là lớp truy cập/triển khai)
**(A) FTP (RFC 959)**
- **Kiến trúc 2 kênh (two-channel model):**
  - **Control channel:** thường TCP/21 (command/response).
  - **Data channel:** mở **riêng** cho mỗi lần truyền dữ liệu/listing (không đi chung TCP/21).
- **Active mode (PORT):**
  - Client báo cho server biết “hãy kết nối tới địa chỉ/port này” để truyền data.
  - Tạo ra rủi ro/khó khăn vận hành qua NAT/firewall; có thể dẫn tới “FTP bounce” trong các kịch bản lịch sử (lạm dụng server làm bên thứ ba kết nối tới mục tiêu).
- **Passive mode (PASV/EPSV):**
  - Server mở port dữ liệu và thông báo cho client kết nối tới.
  - Thực tế triển khai phổ biến hơn vì “dễ qua NAT” nhưng yêu cầu **mở dải port passive** trên firewall → nếu cấu hình lỏng, tăng bề mặt tấn công.

**(B) Bảo mật cho FTP**
- **FTP Security Extensions (RFC 2228)**: các mở rộng lịch sử cho bảo mật.
- **FTPS – Securing FTP with TLS (RFC 4217)**:
  - Dùng **TLS** để mã hóa control channel và/hoặc data channel.
  - Có 2 kiểu thường gặp trong tài liệu vận hành:
    - **Explicit FTPS** (thường trên TCP/21, nâng cấp sang TLS bằng lệnh bảo mật),
    - **Implicit FTPS** (historical, thường TCP/990; không phải chuẩn IETF “mới”, nhưng còn tồn tại trong thực tế).
- **SFTP (SSH File Transfer Protocol)**:
  - *Không phải FTP.* SFTP chạy trên **SSH** (thường TCP/22), 1 kênh, thường dễ firewall hơn và có mô hình bảo mật khác.

**(C) IEEE 802.11, WPA/WPA2/WPA3, EAP (ngữ cảnh khi FTP chạy qua Wi‑Fi)**
- **IEEE 802.11 (Wi‑Fi):** chỉ là lớp truyền dẫn IP. FTP/FTPS chạy trên TCP/IP nên có thể bị ảnh hưởng bởi an ninh WLAN (ai vào được mạng).
- **WPA2/WPA3:**
  - Bảo vệ liên kết radio (client ↔ AP), nhưng **FTP cleartext** vẫn rủi ro nếu attacker:
    - ở cùng mạng “sau AP” (cùng VLAN), hoặc
    - có khả năng bắt gói tại vị trí khác trong đường đi (on‑path), hoặc
    - truy cập được thiết bị trung gian (router/switch mirror).
- **802.1X/EAP (Enterprise):** giúp kiểm soát truy cập (who/what) và cấp VLAN/ACL động → giảm khả năng attacker tiếp cận dịch vụ FTP nội bộ.

### 1.2 Phân tích cơ chế hoạt động: AP / client / IoT device

**(A) Access Point / Switch / Router (vai trò vận chuyển & phân tách mạng)**
- FTP/FTPS phụ thuộc rất nhiều vào:
  - **Policy firewall/NAT** (đặc biệt do có data channel tách rời),
  - **Segmentation VLAN** (để FTP server không lộ ra guest/user VLAN không cần thiết),
  - **FTP ALG / helper** trên router (có thể sửa payload PORT/PASV; đôi khi tạo side effects hoặc làm phức tạp TLS).
- Nếu cấu hình WLAN/guest không cách ly tốt (client isolation tắt, ACL lỏng), attacker có thể:
  - brute‑force dịch vụ FTP nội bộ,
  - dò tìm server cũ (legacy),
  - nghe lén lưu lượng nếu có điểm capture phù hợp.

**(B) Client (máy trạm/ứng dụng)**
- Với **FTP plaintext**:
  - Username/password và dữ liệu **có thể bị lộ** khi bị sniff.
  - Client có thể tự lưu credential trong cấu hình ứng dụng → rủi ro khi bị malware/infostealer.
- Với **FTPS**:
  - Lợi ích phụ thuộc vào **xác thực chứng chỉ** đúng (certificate validation).
  - Nếu client “bỏ qua” cảnh báo chứng chỉ hoặc dùng cấu hình chấp nhận mọi cert → dễ bị AiTM.
- Với **SFTP**:
  - Dựa trên SSH; rủi ro chủ yếu là key management, weak password, và cấu hình SSH.

**(C) IoT/NAS/Printer (server FTP phổ biến trong thực tế)**
- Nhiều NAS/camera/printer cung cấp FTP để upload/download hoặc “scan to FTP”.
- Rủi ro đặc thù IoT:
  - firmware **khó cập nhật**, default credentials,
  - hỗ trợ FTP plaintext nhưng **không** hỗ trợ FTPS/SFTP,
  - quyền thư mục sai → lộ dữ liệu nhạy cảm.

### 1.3 Công cụ & phần mềm thường dùng (tấn công & phòng thủ) — ở mức khái quát
> Chỉ liệt kê để hiểu hệ sinh thái; không hướng dẫn dùng.

**Quan sát/phòng thủ**
- **Wireshark/tcpdump**: phân tích control/data channel; phát hiện truyền rõ (USER/PASS), xác định active/passive behavior, TLS handshake (FTPS).
- **IDS/IPS/NSM**: Suricata/Snort/Zeek phát hiện brute‑force/login anomalies, file transfer anomalies.
- **WAF/Reverse proxy (nếu thay bằng HTTPS file transfer)**: quan sát hành vi upload/download.
- **SIEM**: tương quan log FTP server + firewall + endpoint.

**FTP server software phổ biến (điều tra/hardening)**
- **vsftpd**, **ProFTPD**, **Pure‑FTPd** (Linux/Unix).
- **Microsoft IIS FTP** (Windows).
- **FileZilla Server** (Windows).

**Liên quan Wi‑Fi (không phải lõi FTP)**
- **Kismet**: WIDS/RF recon;  
- **Aircrack‑ng**: audit WLAN (tăng khả năng “vào mạng” nếu WLAN yếu);  
→ các tool này không khai thác FTP trực tiếp nhưng có thể xuất hiện trong “chuỗi tấn công” khi FTP nằm trong mạng Wi‑Fi.

---

## 2) Thuật toán (Algorithms)

### 2.1 Thuật toán mã hóa/xác thực bị khai thác (hoặc thiếu vắng)
**(A) FTP truyền thống**
- **Không mã hóa**:
  - Control channel chứa lệnh và thông tin xác thực dạng rõ,
  - Data channel cũng truyền rõ.
- Xác thực thường là **username/password** (basic), đôi khi anonymous/guest.

**(B) FTPS (TLS)**
- Bảo mật dựa trên **TLS**:
  - Cipher suites (ví dụ AES‑GCM/ChaCha20‑Poly1305…) tùy cấu hình server/client,
  - xác thực server qua certificate chain.
- Rủi ro khi:
  - dùng TLS phiên bản/cipher yếu,
  - cấu hình “implicit/explicit” lẫn lộn,
  - client không xác thực chứng chỉ nghiêm ngặt.

**(C) Wi‑Fi crypto (chỉ liên quan ngữ cảnh truy cập)**
- **WPA2:** AES‑CCMP (chuẩn), TKIP (legacy/không khuyến nghị).
- **WPA3:** SAE (Personal) + PMF mạnh hơn.
> Những thuật toán này bảo vệ “air link”, không giải quyết điểm yếu của FTP plaintext khi attacker nằm ở đoạn mạng khác.

### 2.2 Thuật toán tấn công (khái niệm)
- **Sniffing / credential interception**:
  - khi FTP plaintext chạy qua mạng có khả năng bị nghe lén (LAN/WLAN bị compromise, thiết bị trung gian).
- **Brute‑force / dictionary / password spraying**:
  - thử mật khẩu trên nhiều tài khoản hoặc lặp theo thời gian để tránh lockout.
- **Credential stuffing**:
  - reuse credential bị lộ từ nơi khác (nếu tổ chức dùng lại mật khẩu).
- **Replay / session abuse**:
  - trong các triển khai yếu (đặc biệt khi không mã hóa/integrity).
- **Misconfiguration exploitation**:
  - anonymous write, quyền thư mục sai, chroot/jail cấu hình sai,
  - lộ “directory listing” chứa file nhạy cảm.
- **FTP bounce (lịch sử/khái niệm)**:
  - lợi dụng active mode PORT để khiến server kết nối tới đích khác (phụ thuộc server policy; nhiều server hiện đại đã giảm rủi ro).
- **Malware drop / staging**:
  - dùng FTP như kênh đẩy payload hoặc exfil (thường thấy trong môi trường legacy).

### 2.3 Thuật toán phòng thủ (entropy-based, ML/DL, và hardening)
- **Entropy‑based detection**
  - đo độ phân tán mật khẩu đoán (nhiều tài khoản, ít mật khẩu),
  - spike số lần login fail theo IP/ASN,
  - thay đổi bất thường về file types/size/throughput.
- **ML/DL anomaly detection** (ở SIEM/NDR)
  - phát hiện “rare user” upload vào giờ bất thường,
  - phát hiện mô hình “scan → login failures → success → bulk download/upload”.
- **Hardening “logic”**
  - bắt buộc **TLS**, chặn plaintext,
  - rate‑limit + lockout hợp lý,
  - allowlist IP quản trị hoặc VPN-only,
  - file integrity monitoring cho thư mục upload.

---

## 3) Dependencies

### 3.1 Phụ thuộc firmware/driver/hệ điều hành
- **FTP server implementation** (IIS FTP, vsftpd, ProFTPD…) và phiên bản/patch level.
- **OS & filesystem permissions** (Windows ACL / Linux permissions) quyết định mức độ tác động nếu bị lộ tài khoản.
- **Router/firewall/NAT behavior**:
  - passive port range mapping,
  - ALG/FTP helper có thể làm thay đổi luồng (đặc biệt khi kết hợp TLS).

### 3.2 Phụ thuộc cấu hình người dùng
- Dùng **FTP plaintext** thay vì FTPS/SFTP.
- Mật khẩu yếu/reuse; không có MFA (FTP truyền thống hiếm khi hỗ trợ MFA tốt).
- Client “bỏ qua” kiểm tra chứng chỉ (FTPS), hoặc lưu mật khẩu trong client.

### 3.3 Phụ thuộc hạ tầng mạng (AP/router/IoT gateway)
- FTP server bị expose ra Internet do NAT/port‑forward.
- Thiếu segmentation: server FTP nằm chung VLAN với user/guest/IoT.
- Wi‑Fi: **PSK yếu/WPS bật** hoặc guest không isolation → attacker dễ vào mạng để brute‑force/dò tìm server nội bộ.

---

## 4) Context

### 4.1 Môi trường triển khai
- **Doanh nghiệp:** hệ thống trao đổi file với đối tác B2B; hệ thống legacy; DMZ.
- **Mạng công cộng/café:** FTP client dùng trên Wi‑Fi công cộng (rủi ro sniffing/AiTM).
- **IoT/OT:** camera/NAS/printer/SCADA gateway dùng FTP cho log/upload dữ liệu.
- **Mesh/home:** router consumer expose FTP để truy cập file từ xa.

### 4.2 Kịch bản tấn công (ví dụ)
- **Café Wi‑Fi:** người dùng kết nối FTP plaintext để lấy file → rủi ro lộ credential/contents (nếu attacker có điểm nghe lén/on‑path).
- **Doanh nghiệp:** server FTP trong DMZ bị brute‑force/password spraying → attacker lấy quyền đọc/ghi, chèn file độc.
- **Campus:** NAS/printer bật anonymous FTP hoặc mật khẩu mặc định → lộ dữ liệu và làm điểm staging.

---

## 5) Core Weakness (điểm yếu cốt lõi)

- **FTP truyền thống không mã hóa** → lộ thông tin xác thực & dữ liệu.
- **Two‑channel model** → phức tạp firewall/NAT, dễ sai cấu hình (passive range, ALG), tăng bề mặt.
- **Cấu hình quyền & tài khoản**:
  - anonymous/guest, RW không kiểm soát,
  - chroot/jail sai, quyền thư mục sai.
- **Yếu tố con người**:
  - dùng FTP vì “tiện/quen”, bỏ qua cảnh báo cert (FTPS),
  - reuse mật khẩu, lưu mật khẩu trong client.

---

## 6) Cost & Risk

### 6.1 Chi phí triển khai tấn công
- **Thấp**: sniffing (khi có vị trí phù hợp), brute‑force trên dịch vụ public, dùng tool miễn phí.
- **Trung bình**: nếu phải vượt NAC/VPN, hoặc cần pivot vào VLAN/DMZ.

### 6.2 Chi phí phòng thủ
- **Trung bình**: migrate từ FTP → SFTP/HTTPS; triển khai FTPS đúng chuẩn; IDS/IPS + SIEM.
- **Cao**: thay đổi quy trình B2B, tích hợp IAM/MFA, thay thế IoT/NAS không hỗ trợ giao thức an toàn.

### 6.3 Rủi ro
- **Mất dữ liệu**: exfil file, lộ credentials, lộ PII.
- **Gián đoạn dịch vụ**: xóa/ghi đè file, ransomware staging.
- **Vi phạm pháp lý/tuân thủ**: dữ liệu nhạy cảm bị lộ; không đáp ứng yêu cầu “encrypt in transit” trong nhiều chính sách nội bộ.

---

## 7) Control Surface (các lớp kiểm soát)

### 7.1 Access Point / Access Layer
- **Wi‑Fi nội bộ:** ưu tiên WPA2‑Enterprise/WPA3‑Enterprise (802.1X/EAP), tách VLAN theo role.
- **Guest Wi‑Fi:** client isolation; chặn truy cập tới DMZ/FTP servers.
- **Switch/router:** ACL/Firewall chỉ cho phép FTP/FTPS/SFTP từ nguồn hợp lệ; tránh expose không cần thiết.

### 7.2 Client
- **Nguyên tắc ưu tiên:** dùng **SFTP** hoặc **HTTPS-based file transfer**; hạn chế/loại bỏ FTP plaintext.
- Nếu bắt buộc FTPS:
  - yêu cầu client **validate certificate** (không “trust all certs”),
  - cập nhật client để hỗ trợ TLS hiện đại.
- Khi ở mạng công cộng: dùng **VPN**; tránh truyền file nhạy cảm qua FTP plaintext.

### 7.3 Network Layer
- **IDS/IPS/NDR**: rule phát hiện brute‑force/login anomalies, bulk transfer bất thường.
- **Firewall**:
  - giới hạn port/ passive range, allowlist IP,
  - DMZ segmentation, logging.
- **DLP & monitoring** (tuỳ tổ chức): theo dõi loại file/kích thước/bất thường.

### 7.4 Policy Layer
- **Deprecation plan**: loại bỏ FTP plaintext theo lộ trình; chuyển sang SFTP/HTTPS.
- **Credential policy**: password manager, rotate, không reuse; hạn chế account shared.
- **Change management**: kiểm soát port‑forward/NAT; asset inventory cho server/NAS/IoT.

---

## 8) Chain Value (chuỗi giá trị liên quan)

- **Nhà sản xuất phần cứng:** NAS, router, firewall, AP, thiết bị IoT có FTP server tích hợp.
- **Nhà cung cấp phần mềm:** FTP server software (IIS/vsftpd/ProFTPD…), OS, IDS/IPS, SIEM, DLP.
- **Doanh nghiệp triển khai:** network/security/IT ops, đối tác B2B (kênh trao đổi file).
- **Người dùng cuối:** thao tác upload/download; hành vi xử lý cảnh báo chứng chỉ.
- **Kẻ tấn công:** tận dụng plaintext + misconfig + credential reuse.
- **Cơ quan/chuẩn/pháp luật:** IETF RFC, NIST guidance về TLS/secure transport, các yêu cầu compliance nội bộ/ngành.

---

## References (kèm “Source Preference” và URL)

### P1 — Chuẩn/tiêu chuẩn & tài liệu chính thức (RFC/NIST)
- RFC 959 — File Transfer Protocol (FTP):  
  https://www.rfc-editor.org/rfc/rfc959
- RFC 2228 — FTP Security Extensions:  
  https://www.rfc-editor.org/rfc/rfc2228
- RFC 4217 — Securing FTP with TLS (FTPS):  
  https://www.rfc-editor.org/rfc/rfc4217
- RFC 2428 — FTP Extensions for IPv6 and NATs (EPSV/EPRT):  
  https://www.rfc-editor.org/rfc/rfc2428
- NIST SP 800-52 Rev.2 — Guidelines for the Selection, Configuration, and Use of TLS Implementations:  
  https://csrc.nist.gov/pubs/sp/800/52/r2/final
- NIST SP 800-63B — Digital Identity Guidelines (Authentication & lifecycle):  
  https://pages.nist.gov/800-63-3/sp800-63b.html

### P2 — Khung/hướng dẫn vận hành (tăng khả năng giám sát & IR)
- CISA — Ransomware Guidance (FTP thường bị lạm dụng làm staging/exfil trong hệ sinh thái tấn công; tham khảo IR/mitigation):  
  https://www.cisa.gov/stopransomware/ransomware-guide
- MITRE ATT&CK — Exfiltration Over Alternative Protocol (FTP/SFTP có thể nằm trong nhóm protocol exfil; tham khảo khung phân loại):  
  https://attack.mitre.org/techniques/T1048/

### P4 — Vendor/triển khai tham khảo (bổ sung vận hành)
- Microsoft Learn — Creating a New FTP Site in IIS 7:  
  https://learn.microsoft.com/en-us/iis/publish/using-the-ftp-service/creating-a-new-ftp-site-in-iis-7
- vsftpd (project page – hardening/capabilities):  
  https://security.appspot.com/vsftpd.html
- ProFTPD docs:  
  http://www.proftpd.org/docs/
